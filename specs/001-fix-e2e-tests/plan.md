# Implementation Plan: Fix Frontend E2E Tests

**Branch**: `001-fix-e2e-tests` | **Date**: 2026-02-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-fix-e2e-tests/spec.md`

## Summary

Fix five failing Playwright E2E tests (T019–T023) for the enum flag types feature by correcting selector mismatches between the test code and the actual rendered DOM. Identified bugs include: using `[role="dialog"]` to match a role-less Base UI Popover; using `button:has-text()` for a `<div>` trigger; using `modal.locator('input').first()` which hits the name field instead of value fields; using `filter({ near })` which is not a valid Playwright API; and using visible text to find an aria-label-only icon button. One minimal source change is required: adding `data-testid="type-picker-trigger"` to the FlagCreateRow type picker trigger.

## Technical Context

**Language/Version**: TypeScript 5.x, strict mode
**Primary Dependencies**: Playwright (E2E), React 19.x, Zustand 5.x, `@base-ui/react` (Popover), cmdk (Command), shadcn/ui (Dialog, AlertDialog, Select)
**Storage**: N/A — in-memory Zustand store only; resets on each fresh browser page
**Testing**: Playwright (`apps/web/e2e/`)
**Target Platform**: Web browser (Chromium, Firefox, WebKit)
**Project Type**: Web (monorepo, `apps/web`)
**Performance Goals**: Test suite completes without flaky retries
**Constraints**: Fix scope limited to test file and one minimal `data-testid` attribute addition
**Scale/Scope**: 5 E2E test cases, 1 test file, 1 source component change

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Composition Over Prop Drilling | ✅ PASS | No UI component changes beyond a single `data-testid` attribute |
| II. Feature-Based Architecture | ✅ PASS | Test file in `apps/web/e2e/`; `data-testid` added to existing feature component; no cross-feature imports |
| III. Type-Safe API Contract | ✅ N/A | No network calls; no tRPC/Prisma changes |
| IV. State Isolation — Multiple Stores | ✅ PASS | No store changes; Playwright page isolation leverages existing in-memory reset behavior |
| V. Test Discipline | ✅ PASS | This is the test discipline fix itself; brings E2E suite to green |
| VI. Simplicity & YAGNI | ✅ PASS | Minimal changes — one `data-testid` attribute and selector updates; no new abstractions |

**Post-design re-check**: All principles still pass. No violations to record.

## Project Structure

### Documentation (this feature)

```text
specs/001-fix-e2e-tests/
├── plan.md              # This file
├── research.md          # Phase 0 output — bug inventory and selector analysis
├── data-model.md        # Phase 1 output — entity reference (no changes)
├── quickstart.md        # Phase 1 output — run instructions and selector fix reference
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
apps/web/
├── e2e/
│   └── enum-types.spec.ts          # PRIMARY CHANGE: fix all selectors (T019–T023)
└── src/
    └── features/
        └── feature-flags/
            └── components/
                └── flag-list/
                    └── flag-create-row.tsx   # MINOR CHANGE: add data-testid to trigger
```

**Structure Decision**: Web app (Option 2 from template). Changes are confined to a single test file and one source component file.

## Implementation Design

### Task 1 — Add `data-testid` to FlagCreateRow Type Picker Trigger

**File**: `apps/web/src/features/feature-flags/components/flag-list/flag-create-row.tsx`

Add `data-testid="type-picker-trigger"` to the `FlagElement` used as the TypePicker `trigger` prop. This is required because the element renders as a `<div>` (not a `<button>`), making CSS tag selectors like `button:has-text("Type")` fail.

```diff
 <TypePicker
   mode="assign"
   trigger={
     <FlagElement
+      data-testid="type-picker-trigger"
       onClick={() => setTypePickerOpen(!typePickerOpen)}
       className="cursor-pointer hover:bg-accent/50"
     >
       {getTypeDisplay()}
     </FlagElement>
   }
   onSelect={handleTypeSelect}
 />
```

### Task 2 — Fix T019: Full Creation Flow

**File**: `apps/web/e2e/enum-types.spec.ts`

Fix list for T019:

1. **TypePicker popover detection** (line 22): Replace `[role="dialog"], [role="menu"]` with `[data-slot="popover-content"]`.
2. **Type picker trigger** (line 79): Replace `button:has-text("Type"), button:has-text("+ Type")` with `[data-testid="type-picker-trigger"]`.
3. **Value inputs** (lines 41, 47, 51): Replace `modal.locator('input').first()` and `.nth(1)/.nth(2)` with `modal.locator('input[placeholder="Value..."]').first()/nth(1)/nth(2)`.
4. **Flag row scoping for value control** (lines 92–96): Replace `filter({ near: flagRow })` with `li`-scoped selectors using `page.locator('li').filter({ hasText: 'MyEnumFlag' })`.
5. **Updated type picker detection** (line 63): Same as fix 1 — use `[data-slot="popover-content"]`.
6. **selectValue after changing enum flag value** (lines 104–105): Use `li`-scoped locator for post-change assertion.

### Task 3 — Fix T020: Edit with Value Removal

**File**: `apps/web/e2e/enum-types.spec.ts`

Fix list for T020:

1. **TypePicker popover** (line implicit in setup): Use `[data-slot="popover-content"]` for type picker.
2. **Type picker trigger in flag creation loop** (line 147): Replace `button:has-text("Type")` with `[data-testid="type-picker-trigger"]`.
3. **Value inputs** (lines 121–130): Replace `modal.locator('input').first()/.nth(1)/.nth(2)` with `modal.locator('input[placeholder="Value..."]')` variants.
4. **Flag row value change in loop** (line 161): Replace `filter({ near: flagRow })` with `page.locator('li').filter({ hasText: 'StatusFlag1' })` etc.
5. **Edit button for "Status" type** (line 173): Replace `filter({ hasText: 'Edit' })` with `.first()`.
6. **Confirmation dialog** (line 196): Simplify to `page.locator('[role="alertdialog"]')`.
7. **Post-edit value assertions** (lines 211–215): Use `li`-scoped locators for "active" value assertion.

### Task 4 — Fix T021: Delete with Cascade

**File**: `apps/web/e2e/enum-types.spec.ts`

Fix list for T021:

1. **TypePicker popover**: Use `[data-slot="popover-content"]`.
2. **Type picker trigger in creation loop**: Replace `button:has-text("Type")` with `[data-testid="type-picker-trigger"]`.
3. **Value inputs** (lines 232–236): Replace with `modal.locator('input[placeholder="Value..."]')` variants.
4. **Edit button for "Tier" type** (line 265): Replace `filter({ hasText: 'Edit' })` with `.first()`.
5. **Delete confirmation dialog** (line 280): Simplify to `page.locator('[role="alertdialog"]')`.

### Task 5 — Fix T022: Inline Creation Row Gates

**File**: `apps/web/e2e/enum-types.spec.ts`

Fix list for T022:

1. **Type picker trigger** (lines 327, 355): Replace `button:has-text("Type")` with `[data-testid="type-picker-trigger"]`.
2. **Popover detection for type selection**: Use `[data-slot="popover-content"]` if checking popover visible state.
3. **TypeModal value input** (line 367): Replace `typeModal.locator('input').first()` with `typeModal.locator('input[placeholder="Value..."]').first()`.

### Task 6 — Fix T023: Escape and Click-Outside Dismissal

**File**: `apps/web/e2e/enum-types.spec.ts`

T023 does not interact with the TypePicker trigger or enum type modal, so it may already pass. Verify:

1. Check that the `addFlagButton` selector `button:has-text("Add")` partially matches "Add new flag..." — this should work (Playwright `has-text` does substring match).
2. The "Partial" and "AnotherPartial" text assertions are straightforward — verify they pass as-is.
3. If T023 is already passing, document that and leave it unchanged.

## Selector Quick Reference

| Element | Broken Selector | Fixed Selector |
|---------|----------------|----------------|
| TypePicker popover content | `[role="dialog"],[role="menu"]` | `[data-slot="popover-content"]` |
| `+ Type` trigger (creation row) | `button:has-text("Type")` | `[data-testid="type-picker-trigger"]` |
| Enum type modal | `[role="dialog"]:has-text("Create enum type")` | unchanged — Dialog has `role="dialog"` ✅ |
| Value input (first) | `modal.locator('input').first()` | `modal.locator('input[placeholder="Value..."]').first()` |
| Value input (nth) | `modal.locator('input').nth(N)` | `modal.locator('input[placeholder="Value..."]').nth(N-1)` |
| Edit button | `filter({ hasText: 'Edit' })` | `.first()` (only button in row) |
| Value control (enum flag) | `filter({ near: flagRow })` | `page.locator('li').filter({ hasText: 'Name' }).getByRole('combobox')` |
| Confirmation dialog | `[role="dialog"],[role="alertdialog"]` | `[role="alertdialog"]` |
| Confirm value removal btn | `button:has-text("Remove value")` | unchanged ✅ |
| Delete type btn | `button:has-text("Delete")` | unchanged ✅ |

## Verification Steps

1. Run each test individually to confirm isolated passing:
   ```bash
   pnpm -F web exec playwright test --grep "T019" --project=chromium
   # ... repeat for T020–T023
   ```
2. Run full suite across all browsers:
   ```bash
   pnpm -F web exec playwright test
   ```
3. Expected: 15 tests pass (5 tests × 3 browsers), 0 failures, 0 flaky.
